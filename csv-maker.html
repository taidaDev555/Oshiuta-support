<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OshiUta CSV Maker</title>
<style>
  :root { --bg:#fafafa; --text:#333; --muted:#777; --accent:#4caf50; --border:#ddd; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;line-height:1.7}
  .wrap{max-width:820px;margin:0 auto;padding:20px}
  h1{font-size:1.6rem;margin:.4rem 0 1rem 0;text-align:center}
  p.hint{color:var(--muted);margin:.2rem 0 1rem 0;text-align:center}
  label{display:block;margin:.75rem 0 .25rem 0;font-weight:600}
  input,textarea,select,button{width:100%;box-sizing:border-box;font-size:16px;padding:.6rem;border:1px solid var(--border);border-radius:8px;background:#fff}
  textarea{min-height:9rem;resize:vertical}
  .row{display:grid;gap:12px}
  @media (min-width:720px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{cursor:pointer;border:none;border-radius:8px;padding:.7rem 1rem;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.secondary{background:#eee}
  .note{font-size:.9rem;color:var(--muted)}
  .box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:16px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--border);padding:.4rem .5rem;font-size:.95rem}
  th{background:#f3f3f3}
  .ok{color:#1b5e20;font-weight:700}
  .err{color:#b00020;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>OshiUta CSV Maker</h1>
  <p class="hint">URLと曲リストを入れるだけで、<b>OshiUta</b> 互換の <span class="mono">songlist.csv</span> を作れます（オフラインで動作）</p>

  <div class="box">
    <div class="row cols-2">
      <div>
        <label>配信日（YYYY/MM/DD）</label>
        <input id="streamDate" placeholder="2025/10/20" inputmode="numeric"/>
      </div>
      <div>
        <label>配信者名（Streamer）</label>
        <input id="streamer" placeholder="花鹿める"/>
      </div>
    </div>
    <div class="row cols-2">
      <div>
        <label>配信タイトル</label>
        <input id="streamTitle" placeholder="秋の歌枠"/>
      </div>
      <div>
        <label>YouTube URL または Video ID</label>
        <input id="youtubeURL" placeholder="https://youtu.be/xxxxxxxxxxx"/>
      </div>
    </div>
    <div class="row cols-3">
      <div>
        <label>デフォルト曲長さ（秒）</label>
        <input id="defaultDuration" type="number" min="10" step="10" value="600"/>
      </div>
      <div>
        <label>EndSec 処理</label>
        <select id="endMode">
          <option value="compute">StartSec + デフォルト長で自動計算</option>
          <option value="blank">EndSecを空欄にする</option>
        </select>
      </div>
      <div>
        <label>区切り（高度）</label>
        <select id="delimiter">
          <option value=",">カンマ（,）</option>
          <option value="tab">タブ</option>
        </select>
      </div>
    </div>

    <label>曲リスト入力</label>
    <textarea id="songs" placeholder="下記いずれの形式でもOK（1行1曲）&#10;例1）紅蓮華,LiSA,1:23&#10;例2）1:23 紅蓮華 - LiSA&#10;例3）12:40 残酷な天使のテーゼ"></textarea>

    <div class="actions">
      <button class="btn secondary" id="loadSample">サンプル挿入</button>
      <button class="btn primary" id="make">CSVを生成してダウンロード</button>
      <button class="btn secondary" id="preview">プレビュー表示</button>
      <button class="btn secondary" id="copy">CSVをコピー</button>
      <span class="note">※ プレビューは下に表示されます。Excel対策でCSVはUTF-8（BOM付き）で出力します。</span>
    </div>
  </div>

  <div id="status" class="box" style="display:none"></div>

  <div id="previewBox" class="box" style="display:none">
    <div class="mono" id="headerLine">StreamDate,StreamTitle,Streamer,VideoId,Title,Artist,StartSec,EndSec</div>
    <table id="previewTable">
      <thead><tr>
        <th>StreamDate</th><th>StreamTitle</th><th>Streamer</th><th>VideoId</th>
        <th>Title</th><th>Artist</th><th>StartSec</th><th>EndSec</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="box">
    <details>
      <summary>Tips（読み取りルール・時刻の書き方）</summary>
      <ul>
        <li>時刻は <span class="mono">h:mm:ss / mm:ss / ss</span> いずれでもOK。全角数字・全角コロンも自動で半角化します。</li>
        <li>1行の形式は「<b>Title,Artist,Time</b>」「<b>Time Title - Artist</b>」「<b>Time Title</b>」のいずれかに対応。</li>
        <li>YouTube欄はフルURLでも動画ID（11文字）でもOK。自動抽出します。</li>
        <li>EndSecは「空欄」か「StartSec + デフォルト長」のどちらかを選択できます。</li>
      </ul>
    </details>
  </div>

  <footer class="wrap" style="text-align:center;color:#777;font-size:.9rem">
    © 2025 taida-agency Development Team · Offline tool (no server)
  </footer>
</div>

<script>
  // 全角→半角（数字・コロン・スペース）
  function toHalfWidth(str){
    if(!str) return "";
    return str.replace(/[！-～]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0))
              .replace(/　/g," ");
  }

  // 時刻を秒に：h:mm:ss / mm:ss / ss
  function parseTimeToSec(raw){
    if(!raw) return NaN;
    const s = toHalfWidth(String(raw)).trim();
    if(!s) return NaN;
    const parts = s.split(":").map(p=>p.trim());
    if(parts.length===1) {
      const val = Number(parts[0]);
      return Number.isFinite(val) ? Math.max(0, Math.floor(val)) : NaN;
    }
    if(parts.length===2){
      const m = Number(parts[0]), sec = Number(parts[1]);
      if(!Number.isFinite(m)||!Number.isFinite(sec)) return NaN;
      return Math.max(0, Math.floor(m*60 + sec));
    }
    if(parts.length===3){
      const h = Number(parts[0]), m = Number(parts[1]), sec = Number(parts[2]);
      if(!Number.isFinite(h)||!Number.isFinite(m)||!Number.isFinite(sec)) return NaN;
      return Math.max(0, Math.floor(h*3600 + m*60 + sec));
    }
    return NaN;
  }

  // YouTube URL から動画ID抽出（または11桁そのもの）
  function extractVideoId(input){
    const s = (input||"").trim();
    if(!s) return "";
    if(/^[A-Za-z0-9_-]{11}$/.test(s)) return s;
    try{
      const u = new URL(s);
      const v = u.searchParams.get("v");
      if(v && /^[A-Za-z0-9_-]{11}$/.test(v)) return v;
      const last = u.pathname.split("/").filter(Boolean).pop() || "";
      if(/^[A-Za-z0-9_-]{11}$/.test(last)) return last;
    }catch(e){}
    return "";
  }

  // 1行を解析：3パターンに対応
  // A) "Title,Artist,1:23"
  // B) "1:23 Title - Artist"
  // C) "1:23 Title"（Artist省略）
  function parseLine(line, fallbackArtist=""){
    const raw = toHalfWidth(line).trim();
    if(!raw) return null;

    // A) カンマ区切り：Title,Artist,Time
    const csvParts = raw.split(",").map(x=>x.trim());
    if(csvParts.length>=3 && parseTimeToSec(csvParts[csvParts.length-1]).toString()!=="NaN"){
      const timeStr = csvParts.pop();
      const artist = csvParts.pop();
      const title = csvParts.join(",").trim(); // タイトル中のカンマも許容
      const start = parseTimeToSec(timeStr);
      if(!title || Number.isNaN(start)) return null;
      return {title, artist, start};
    }

    // B/C) 先頭が時刻
    const m = raw.match(/^(\d{1,2}:\d{1,2}(?::\d{1,2})?|\d{1,5})\s+(.+)$/);
    if(m){
      const start = parseTimeToSec(m[1]);
      if(Number.isNaN(start)) return null;
      const rest = m[2];
      // "Title - Artist" または "Title ― Artist" 対応
      const sp = rest.split(/\s[-–—―]\s/);
      const title = sp[0].trim();
      const artist = (sp[1]||fallbackArtist||"").trim();
      if(!title) return null;
      return {title, artist, start};
    }

    return null;
  }

  function buildRows(){
    const date = document.getElementById("streamDate").value.trim() || "2025/01/01";
    const title = document.getElementById("streamTitle").value.trim() || "無題の配信";
    const streamer = document.getElementById("streamer").value.trim() || "不明";
    const url = document.getElementById("youtubeURL").value.trim();
    const defaultDuration = parseInt(document.getElementById("defaultDuration").value)||600;
    const endMode = document.getElementById("endMode").value;
    const delim = document.getElementById("delimiter").value;
    const videoId = extractVideoId(url);
    const text = document.getElementById("songs").value;

    if(!videoId) throw new Error("有効な YouTube URL / 動画ID を入力してください。");
    if(!text.trim()) throw new Error("曲リストを入力してください。");

    const sep = (delim==="tab") ? "\t" : ",";
    const lines = text.split(/\r?\n/);
    const rows = [];

    for(const ln of lines){
      if(!ln.trim()) continue;
      const parsed = parseLine(ln);
      if(!parsed){ continue; }
      const start = parsed.start;
      const end = (endMode==="blank") ? "" : String(start + defaultDuration);
      const row = [date, title, streamer, videoId, parsed.title, parsed.artist||"", String(start), end];
      rows.push(row.map(s=>String(s).replaceAll('"','""'))); // CSVエスケープ準備
    }
    if(rows.length===0) throw new Error("有効な行が見つかりませんでした。形式を確認してください。");

    // CSV文字列
    let header = "StreamDate,StreamTitle,Streamer,VideoId,Title,Artist,StartSec,EndSec";
    let csv = header + "\n";
    for(const r of rows){
      // カンマ/タブどちらでもダウンロードは .csv とする（Excel想定）
      const line = r.map(x => (sep==="," && /[",\n]/.test(x)) ? `"${x}"` : x).join(sep);
      csv += line + "\n";
    }
    return {csv, rows, header, sep};
  }

  function downloadCSV(content){
    const bom = new Uint8Array([0xEF,0xBB,0xBF]);
    const blob = new Blob([bom, content], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "songlist.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function setStatus(msg, ok=true){
    const st = document.getElementById("status");
    st.style.display = "block";
    st.innerHTML = ok ? `<span class="ok">✅ ${msg}</span>` : `<span class="err">❌ ${msg}</span>`;
  }

  // Handlers
  document.getElementById("make").addEventListener("click", ()=>{
    try{
      const {csv} = buildRows();
      downloadCSV(csv);
      setStatus("CSV をダウンロードしました。");
    }catch(e){ setStatus(e.message, false); }
  });

  document.getElementById("preview").addEventListener("click", ()=>{
    try{
      const {rows} = buildRows();
      const tb = document.querySelector("#previewTable tbody");
      tb.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        for(const c of r){
          const td = document.createElement("td");
          td.textContent = c;
          tr.appendChild(td);
        }
        tb.appendChild(tr);
      }
      document.getElementById("previewBox").style.display = "block";
      setStatus(`プレビュー行数：${rows.length} 件`);
    }catch(e){ setStatus(e.message, false); }
  });

  document.getElementById("copy").addEventListener("click", async ()=>{
    try{
      const {csv} = buildRows();
      await navigator.clipboard.writeText(csv);
      setStatus("CSV をクリップボードにコピーしました。");
    }catch(e){ setStatus(e.message, false); }
  });

  document.getElementById("loadSample").addEventListener("click", ()=>{
    const sample = [
      "紅蓮華,LiSA,1:23",
      "1:10:05 ブルーバード - いきものがかり",
      "12:40 残酷な天使のテーゼ",
      "03:05 タッチ - 岩崎良美",
    ].join("\n");
    document.getElementById("songs").value = sample;
    setStatus("サンプルを挿入しました。");
  });
</script>
</body>
</html>
