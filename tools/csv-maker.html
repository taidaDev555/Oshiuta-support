<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OshiUta CSV Maker (EN / 中文 / 日本語)</title>
<style>
  :root { --bg:#fafafa; --text:#333; --muted:#777; --accent:#4caf50; --border:#ddd; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Noto Sans TC",sans-serif;line-height:1.7}
  .wrap{max-width:880px;margin:0 auto;padding:18px}
  h1{font-size:1.4rem;margin:.2rem 0 1rem 0;text-align:center}
  .langbar{display:flex;gap:8px;justify-content:center;margin:.5rem 0 1rem}
  .langbar button{border:1px solid var(--border);background:#fff;padding:.4rem .7rem;border-radius:999px;cursor:pointer}
  .langbar button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  p.hint{color:var(--muted);margin:.2rem 0 1rem 0;text-align:center}
  label{display:block;margin:.75rem 0 .25rem 0;font-weight:600}
  input,textarea,select,button{width:100%;box-sizing:border-box;font-size:16px;padding:.6rem;border:1px solid var(--border);border-radius:8px;background:#fff}
  textarea{min-height:9rem;resize:vertical}
  .row{display:grid;gap:12px}
  @media (min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{cursor:pointer;border:none;border-radius:8px;padding:.7rem 1rem;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.secondary{background:#eee}
  .note{font-size:.9rem;color:var(--muted)}
  .box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:16px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--border);padding:.4rem .5rem;font-size:.95rem}
  th{background:#f3f3f3}
  .ok{color:#1b5e20;font-weight:700}
  .err{color:#b00020;font-weight:700}
  footer{margin-top:18px;text-align:center;color:#777;font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">OshiUta CSV Maker</h1>

  <div class="langbar">
    <button id="lang-en" class="active" data-lang="en">English</button>
    <button id="lang-zh" data-lang="zh">中文（繁體）</button>
    <button id="lang-ja" data-lang="ja">日本語</button>
  </div>

  <p class="hint" id="hint">
    Create an <b>OshiUta</b>-compatible <span class="mono">songlist.csv</span> in your browser (offline).<br>
    CSV header is fixed in <b>English</b>.
  </p>

  <div class="box">
    <div class="row cols-2">
      <div>
        <label id="lbl-date">Stream Date (YYYY/MM/DD)</label>
        <input id="streamDate" placeholder="2025/10/20" inputmode="numeric"/>
      </div>
      <div>
        <label id="lbl-streamer">Streamer</label>
        <input id="streamer" placeholder="Sample Streamer"/>
      </div>
    </div>
    <div class="row cols-2">
      <div>
        <label id="lbl-title">Stream Title</label>
        <input id="streamTitle" placeholder="Summer Karaoke (Sample)"/>
      </div>
      <div>
        <label id="lbl-url">YouTube URL or Video ID</label>
        <input id="youtubeURL" placeholder="https://youtu.be/xxxxxxxxxxx"/>
      </div>
    </div>
    <div class="row cols-3">
      <div>
        <label id="lbl-duration">Default song length (sec)</label>
        <input id="defaultDuration" type="number" min="10" step="10" value="600"/>
      </div>
      <div>
        <label id="lbl-endmode">EndSec behavior</label>
        <select id="endMode">
          <option value="compute" id="opt-compute">Auto: StartSec + default length</option>
          <option value="blank" id="opt-blank">Leave EndSec blank</option>
        </select>
      </div>
      <div>
        <label id="lbl-delim">Delimiter (advanced)</label>
        <select id="delimiter">
          <option value="," id="opt-comma">Comma (,)</option>
          <option value="tab" id="opt-tab">Tab</option>
        </select>
      </div>
    </div>

    <label id="lbl-songs">Song list input</label>
    <textarea id="songs" placeholder="One song per line. Any of the following formats are accepted:
Sample Song A,Test Artist,1:23
1:23 Sample Song B - Test Artist
12:40 Sample Song C"></textarea>

    <div class="actions">
      <button class="btn secondary" id="loadSample">Insert sample</button>
      <button class="btn primary" id="make">Download CSV</button>
      <button class="btn secondary" id="preview">Show preview</button>
      <button class="btn secondary" id="copy">Copy CSV</button>
      <span class="note" id="note">Preview appears below. CSV is saved as UTF-8 with BOM for Excel compatibility.</span>
    </div>
  </div>

  <div id="status" class="box" style="display:none"></div>

  <div id="previewBox" class="box" style="display:none">
    <div class="mono" id="headerLine">StreamDate,StreamTitle,Streamer,VideoId,Title,Artist,StartSec,EndSec</div>
    <table id="previewTable">
      <thead><tr>
        <th>StreamDate</th><th>StreamTitle</th><th>Streamer</th><th>VideoId</th>
        <th>Title</th><th>Artist</th><th>StartSec</th><th>EndSec</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="box">
    <details>
      <summary id="tips-title">Tips (parsing rules & time formats)</summary>
      <ul id="tips-list">
        <li>Times supported: <span class="mono">h:mm:ss / mm:ss / ss</span>. Full-width digits/colons are normalized automatically.</li>
        <li>Line formats accepted: <b>Title,Artist,Time</b> / <b>Time Title - Artist</b> / <b>Time Title</b>.</li>
        <li>YouTube field accepts a full URL or 11-char video ID; the app extracts the ID.</li>
        <li>EndSec can be blank, or computed as <b>StartSec + default length</b>.</li>
      </ul>
    </details>
  </div>

  <footer>
    © 2025 taida-agency Development Team · Offline tool (no server) · CSV header language: English
  </footer>
</div>

<script>
/* =========================
   i18n dictionary
   ========================= */
const T = {
  en: {
    title: "OshiUta CSV Maker",
    hint: "Create an <b>OshiUta</b>-compatible <span class='mono'>songlist.csv</span> in your browser (offline).<br>CSV header is fixed in <b>English</b>.",
    date: "Stream Date (YYYY/MM/DD)",
    streamer: "Streamer",
    stitle: "Stream Title",
    url: "YouTube URL or Video ID",
    duration: "Default song length (sec)",
    endmode: "EndSec behavior",
    compute: "Auto: StartSec + default length",
    blank: "Leave EndSec blank",
    delim: "Delimiter (advanced)",
    comma: "Comma (,)",
    tab: "Tab",
    songs: "Song list input",
    songsPH: "One song per line. Any of the following formats are accepted:\nSample Song A,Test Artist,1:23\n1:23 Sample Song B - Test Artist\n12:40 Sample Song C",
    btnSample: "Insert sample",
    btnMake: "Download CSV",
    btnPreview: "Show preview",
    btnCopy: "Copy CSV",
    note: "Preview appears below. CSV is saved as UTF-8 with BOM for Excel compatibility.",
    tipsTitle: "Tips (parsing rules & time formats)",
    tips: [
      "Times supported: h:mm:ss / mm:ss / ss. Full-width digits/colons are normalized automatically.",
      "Line formats accepted: Title,Artist,Time / Time Title - Artist / Time Title.",
      "YouTube field accepts a full URL or 11-char video ID; the app extracts the ID.",
      "EndSec can be blank, or computed as StartSec + default length."
    ],
    statusOK: "CSV downloaded.",
    statusPreview: rows => `Preview rows: ${rows} item(s).`,
    statusCopy: "CSV copied to clipboard.",
    errURL: "Please enter a valid YouTube URL or video ID.",
    errSongs: "Please enter at least one song line.",
    errNoRows: "No valid rows found. Please check the input format.",
    defaultTitle: "Untitled stream",
    defaultStreamer: "Unknown"
  },
  zh: {
    title: "OshiUta CSV 產生器",
    hint: "在瀏覽器中離線建立 <b>OshiUta</b> 相容的 <span class='mono'>songlist.csv</span>。<br>CSV 標頭固定為 <b>英文</b>。",
    date: "直播日期（YYYY/MM/DD）",
    streamer: "主播／歌手",
    stitle: "直播標題",
    url: "YouTube 連結或影片 ID",
    duration: "預設曲長（秒）",
    endmode: "EndSec 行為",
    compute: "自動：StartSec + 預設曲長",
    blank: "EndSec 留白",
    delim: "分隔符（進階）",
    comma: "逗號（,）",
    tab: "定位字元（Tab）",
    songs: "歌曲清單輸入",
    songsPH: "每行一首，可用以下格式：\nSample Song A,Test Artist,1:23\n1:23 Sample Song B - Test Artist\n12:40 Sample Song C",
    btnSample: "插入範例",
    btnMake: "下載 CSV",
    btnPreview: "顯示預覽",
    btnCopy: "複製 CSV",
    note: "預覽會顯示在下方。CSV 以含 BOM 的 UTF-8 儲存，與 Excel 相容。",
    tipsTitle: "提示（解析規則與時刻格式）",
    tips: [
      "支援時刻：h:mm:ss / mm:ss / ss。會自動正規化全形數字與冒號。",
      "支援行格式：Title,Artist,Time / Time Title - Artist / Time Title。",
      "YouTube 欄可填完整連結或 11 字影片 ID；工具會自動擷取 ID。",
      "EndSec 可留白，或以 StartSec + 預設曲長自動計算。"
    ],
    statusOK: "已下載 CSV。",
    statusPreview: rows => `預覽筆數：${rows} 筆。`,
    statusCopy: "已複製 CSV 至剪貼簿。",
    errURL: "請輸入有效的 YouTube 連結或影片 ID。",
    errSongs: "請輸入至少一行歌曲資料。",
    errNoRows: "找不到有效的資料。請確認輸入格式。",
    defaultTitle: "Untitled stream",
    defaultStreamer: "Unknown"
  },
  ja: {
    title: "OshiUta CSV Maker",
    hint: "ブラウザだけで <b>OshiUta</b> 互換の <span class='mono'>songlist.csv</span> を作成できます（オフライン動作）。<br>CSV のヘッダは<b>英語固定</b>です。",
    date: "配信日（YYYY/MM/DD）",
    streamer: "配信者名",
    stitle: "配信タイトル",
    url: "YouTube URL または Video ID",
    duration: "デフォルト曲長（秒）",
    endmode: "EndSec の扱い",
    compute: "自動：StartSec + デフォルト長",
    blank: "EndSec を空欄にする",
    delim: "区切り（上級）",
    comma: "カンマ (,)",
    tab: "タブ",
    songs: "曲リスト入力",
    songsPH: "1行1曲。以下の形式に対応：\nSample Song A,Test Artist,1:23\n1:23 Sample Song B - Test Artist\n12:40 Sample Song C",
    btnSample: "サンプル挿入",
    btnMake: "CSVをダウンロード",
    btnPreview: "プレビュー表示",
    btnCopy: "CSVをコピー",
    note: "プレビューは下に表示。CSVはUTF-8（BOM付き）で保存し、Excelで文字化けしにくい形式です。",
    tipsTitle: "Tips（解釈ルール・時刻の書き方）",
    tips: [
      "時刻は h:mm:ss / mm:ss / ss をサポート。全角数字・コロンは自動で半角化します。",
      "行の形式：Title,Artist,Time / Time Title - Artist / Time Title。",
      "YouTube 欄はフルURLまたは11文字の動画IDを入力可能。IDは自動抽出されます。",
      "EndSec は空欄でも可。もしくは StartSec + デフォルト長で自動計算。"
    ],
    statusOK: "CSV をダウンロードしました。",
    statusPreview: rows => `プレビュー行数：${rows} 件`,
    statusCopy: "CSV をクリップボードにコピーしました。",
    errURL: "有効な YouTube URL / 動画ID を入力してください。",
    errSongs: "曲リストを入力してください。",
    errNoRows: "有効な行が見つかりません。入力形式を確認してください。",
    defaultTitle: "Untitled stream",
    defaultStreamer: "Unknown"
  }
};

let currentLang = "en";
function applyLang(lang){
  currentLang = lang;
  document.querySelectorAll(".langbar button").forEach(b=>{
    b.classList.toggle("active", b.dataset.lang===lang);
  });
  const t = T[lang];
  document.getElementById("title").innerHTML = t.title;
  document.getElementById("hint").innerHTML = t.hint;
  document.getElementById("lbl-date").textContent = t.date;
  document.getElementById("lbl-streamer").textContent = t.streamer;
  document.getElementById("lbl-title").textContent = t.stitle;
  document.getElementById("lbl-url").textContent = t.url;
  document.getElementById("lbl-duration").textContent = t.duration;
  document.getElementById("lbl-endmode").textContent = t.endmode;
  document.getElementById("opt-compute").textContent = t.compute;
  document.getElementById("opt-blank").textContent = t.blank;
  document.getElementById("lbl-delim").textContent = t.delim;
  document.getElementById("opt-comma").textContent = t.comma;
  document.getElementById("opt-tab").textContent = t.tab;
  document.getElementById("lbl-songs").textContent = t.songs;
  document.getElementById("songs").placeholder = t.songsPH;
  document.getElementById("loadSample").textContent = t.btnSample;
  document.getElementById("make").textContent = t.btnMake;
  document.getElementById("preview").textContent = t.btnPreview;
  document.getElementById("copy").textContent = t.btnCopy;
  document.getElementById("note").textContent = t.note;
  document.getElementById("tips-title").textContent = t.tipsTitle;
  const ul = document.getElementById("tips-list");
  ul.innerHTML = "";
  t.tips.forEach(s=>{
    const li = document.createElement("li");
    li.textContent = s;
    ul.appendChild(li);
  });
}

/* =========================
   helpers
   ========================= */
function toHalfWidth(str){
  if(!str) return "";
  return str.replace(/[！-～]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0))
            .replace(/　/g," ");
}

function parseTimeToSec(raw){
  if(!raw) return NaN;
  const s = toHalfWidth(String(raw)).trim();
  if(!s) return NaN;
  const parts = s.split(":").map(p=>p.trim());
  if(parts.length===1){
    const v = Number(parts[0]);
    return Number.isFinite(v) ? Math.max(0, Math.floor(v)) : NaN;
  }
  if(parts.length===2){
    const m = Number(parts[0]), sec = Number(parts[1]);
    if(!Number.isFinite(m)||!Number.isFinite(sec)) return NaN;
    return Math.max(0, Math.floor(m*60 + sec));
  }
  if(parts.length===3){
    const h = Number(parts[0]), m = Number(parts[1]), sec = Number(parts[2]);
    if(!Number.isFinite(h)||!Number.isFinite(m)||!Number.isFinite(sec)) return NaN;
    return Math.max(0, Math.floor(h*3600 + m*60 + sec));
  }
  return NaN;
}

function extractVideoId(input){
  const s = (input||"").trim();
  if(!s) return "";
  if(/^[A-Za-z0-9_-]{11}$/.test(s)) return s;
  try{
    const u = new URL(s);
    const v = u.searchParams.get("v");
    if(v && /^[A-Za-z0-9_-]{11}$/.test(v)) return v;
    const last = u.pathname.split("/").filter(Boolean).pop() || "";
    if(/^[A-Za-z0-9_-]{11}$/.test(last)) return last;
  }catch(e){}
  return "";
}

// Parse one line:
// A) "Title,Artist,1:23"
// B) "1:23 Title - Artist"
// C) "1:23 Title" (artist omitted)
function parseLine(line){
  const raw = toHalfWidth(line).trim();
  if(!raw) return null;

  // A) CSV-like: Title,Artist,Time
  const parts = raw.split(",").map(x=>x.trim());
  if(parts.length>=3 && !Number.isNaN(parseTimeToSec(parts[parts.length-1]))){
    const timeStr = parts.pop();
    const artist = parts.pop();
    const title = parts.join(",").trim();
    const start = parseTimeToSec(timeStr);
    if(!title || Number.isNaN(start)) return null;
    return {title, artist, start};
  }

  // B/C) starts with time
  const m = raw.match(/^(\d{1,2}:\d{1,2}(?::\d{1,2})?|\d{1,5})\s+(.+)$/);
  if(m){
    const start = parseTimeToSec(m[1]);
    if(Number.isNaN(start)) return null;
    const rest = m[2];
    const sp = rest.split(/\s[-–—―]\s/); // "Title - Artist" variations
    const title = sp[0].trim();
    const artist = (sp[1]||"").trim();
    if(!title) return null;
    return {title, artist, start};
  }
  return null;
}

function buildRows(){
  const t = T[currentLang];
  const date = document.getElementById("streamDate").value.trim() || "2025/01/01";
  const title = document.getElementById("streamTitle").value.trim() || t.defaultTitle; // CSV values are fine to be English default
  const streamer = document.getElementById("streamer").value.trim() || t.defaultStreamer;
  const url = document.getElementById("youtubeURL").value.trim();
  const defaultDuration = parseInt(document.getElementById("defaultDuration").value)||600;
  const endMode = document.getElementById("endMode").value;
  const delim = document.getElementById("delimiter").value;
  const videoId = extractVideoId(url);
  const text = document.getElementById("songs").value;

  if(!videoId) throw new Error(t.errURL);
  if(!text.trim()) throw new Error(t.errSongs);

  const sep = (delim==="tab") ? "\t" : ",";
  const lines = text.split(/\r?\n/);
  const rows = [];

  for(const ln of lines){
    if(!ln.trim()) continue;
    const parsed = parseLine(ln);
    if(!parsed) continue;
    const start = parsed.start;
    const end = (endMode==="blank") ? "" : String(start + defaultDuration);
    const row = [date, title, streamer, videoId, parsed.title, parsed.artist||"", String(start), end];
    rows.push(row.map(s=>String(s).replaceAll('"','""')));
  }
  if(rows.length===0) throw new Error(t.errNoRows);

  // CSV header is fixed in English
  let header = "StreamDate,StreamTitle,Streamer,VideoId,Title,Artist,StartSec,EndSec";
  let csv = header + "\n";
  for(const r of rows){
    const line = r.map(x => (sep==="," && /[\",\n]/.test(x)) ? `"${x}"` : x).join(sep);
    csv += line + "\n";
  }
  return {csv, rows, sep};
}

function downloadCSV(content){
  const bom = new Uint8Array([0xEF,0xBB,0xBF]); // UTF-8 BOM for Excel
  const blob = new Blob([bom, content], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "songlist.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

function setStatus(msg, ok=true){
  const st = document.getElementById("status");
  st.style.display = "block";
  st.innerHTML = ok ? `<span class="ok">✅ ${msg}</span>` : `<span class="err">❌ ${msg}</span>`;
}

/* =========================
   events
   ========================= */
document.querySelectorAll(".langbar button").forEach(btn=>{
  btn.addEventListener("click", ()=>applyLang(btn.dataset.lang));
});

document.getElementById("make").addEventListener("click", ()=>{
  try{
    const {csv} = buildRows();
    downloadCSV(csv);
    setStatus(T[currentLang].statusOK);
  }catch(e){ setStatus(e.message, false); }
});

document.getElementById("preview").addEventListener("click", ()=>{
  try{
    const {rows} = buildRows();
    const tb = document.querySelector("#previewTable tbody");
    tb.innerHTML = "";
    for(const r of rows){
      const tr = document.createElement("tr");
      for(const c of r){
        const td = document.createElement("td");
        td.textContent = c;
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
    document.getElementById("previewBox").style.display = "block";
    setStatus(T[currentLang].statusPreview(rows.length));
  }catch(e){ setStatus(e.message, false); }
});

document.getElementById("copy").addEventListener("click", async ()=>{
  try{
    const {csv} = buildRows();
    await navigator.clipboard.writeText(csv);
    setStatus(T[currentLang].statusCopy);
  }catch(e){ setStatus(e.message, false); }
});

document.getElementById("loadSample").addEventListener("click", ()=>{
  const sample = [
    "Sample Song A,Test Artist,1:23",
    "1:10:05 Sample Song B - Test Artist",
    "12:40 Sample Song C",
    "03:05 Sample Song D - Test Artist"
  ].join("\n");
  document.getElementById("songs").value = sample;
  setStatus("Sample inserted.");
});

// initialize
applyLang("en");
</script>
</body>
</html>
